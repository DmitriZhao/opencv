<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Image Bitwise Example</title>
<link href="js_example_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<h2>Image Bitwise Example</h2>
<p>
    Canvas elements named <b>imageCanvasInput</b>, <b>logoCanvasInput</b> and <b>CanvasOutput</b> have been prepared.
    Choose images and click <b>Try it</b> button to see the result.
    You can change the code in the textbox to investigate more.
</p>
<div>
<button id="tryIt" disabled onclick="executeCode('codeEditor', 'errorMessage')">Try it</button>
<br>
<textarea class="code" rows="8" cols="80" id="codeEditor" spellcheck="false">
</textarea>
<p class="err" id="errorMessage"></p>
</div>
<div>
    <div class="inputoutput">
        <canvas id="imageCanvasInput"></canvas>
        <div class="caption">imageCanvasInput <input type="file" id="imageFileInput" name="file" /></div>
    </div>
    <div class="inputoutput">
        <canvas id="logoCanvasInput"></canvas>
        <div class="caption">logoCanvasInput <input type="file" id="logoFileInput" name="file" /></div>
    </div>
    <div class="inputoutput">
        <canvas id="canvasOutput"></canvas>
        <div class="caption">canvasOutput</div>
    </div>
</div>
<script src="utils.js" type="text/javascript"></script>
<script id="codeSnippet" type="text/code-snippet">
let src = cv.imread('imageCanvasInput');
let logo = cv.imread('logoCanvasInput');
let dst = new cv.Mat();
let roi = new cv.Mat();
let mask = new cv.Mat();
let maskInv = new cv.Mat();
let imgBg = new cv.Mat();
let imgFg = new cv.Mat();
let sum = new cv.Mat();
let rect = new cv.Rect(0, 0, logo.cols, logo.rows);

// I want to put logo on top-left corner, So I create a ROI
roi = src.roi(rect);

// Create a mask of logo and create its inverse mask also
cv.cvtColor(logo, mask, cv.COLOR_RGBA2GRAY, 0);
cv.threshold(mask, mask, 100, 255, cv.THRESH_BINARY);
cv.bitwise_not(mask, maskInv);

// Black-out the area of logo in ROI
cv.bitwise_and(roi, roi, imgBg, maskInv);

// Take only region of logo from logo image
cv.bitwise_and(logo, logo, imgFg, mask);

// Put logo in ROI and modify the main image
cv.add(imgBg, imgFg, sum);

dst = src.clone();
for (let i = 0; i < logo.rows; i++) {
    for (let j = 0; j < logo.cols; j++) {
        dst.ucharPtr(i, j)[0] = sum.ucharPtr(i, j)[0];
    }
}
cv.imshow('canvasOutput', dst);
src.delete(); dst.delete(); logo.delete(); roi.delete(); mask.delete();
maskInv.delete(); imgBg.delete(); imgFg.delete(); sum.delete();
</script>
<script type="text/javascript">
loadCode('codeSnippet', 'codeEditor');
loadImageToCanvas('lena.jpg', 'imageCanvasInput');
loadImageToCanvas('lenaFace.png', 'logoCanvasInput');
addFileInputHandler('imageFileInput', 'imageCanvasInput');
addFileInputHandler('logoFileInput', 'logoCanvasInput');
function onOpenCvReady() { // eslint-disable-line no-unused-vars
    document.getElementById('tryIt').removeAttribute('disabled');
}
</script>
<script async src="opencv.js" type="text/javascript" onload="onOpenCvReady();" onerror="onOpenCvLoadError('errorMessage');"></script>
</body>
</html>